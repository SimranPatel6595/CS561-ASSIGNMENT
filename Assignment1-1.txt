/*--NAME : SIMRAN SUNILKUMAR PATEL --*/
/*--CWID : 2011395 --*/

/*----------Query 1----------*/

WITH S_DATA AS 
(SELECT S.PROD , MAX(S.QUANT) MAX_Q, MIN(S.QUANT) MIN_Q, AVG(S.QUANT) AVG_Q 
 FROM SALES S 
 GROUP BY S.PROD),
 MAX_DATA AS (
	SELECT SD.PROD, SD.MAX_Q, S1.CUST MAX_CUST,  S1.DATE MAX_DATE,  S1.STATE ST, SD.AVG_Q 
	 FROM SALES S1, S_DATA SD
 	WHERE S1.PROD = SD.PROD
 	AND S1.QUANT = SD.MAX_Q),
 MIN_DATA AS (
	 SELECT SD.PROD, SD.MIN_Q, S1.CUST MIN_CUST,  S1.DATE MIN_DATE,  S1.STATE ST 
	 FROM SALES S1, S_DATA SD
 	WHERE S1.PROD = SD.PROD
 	AND S1.QUANT = SD.MIN_Q)
SELECT M1.PROD PRODUCT, M1.MAX_Q,M1.MAX_CUST,M1.MAX_DATE,M1.ST,M2.MIN_Q,M2.MIN_CUST,M2.MIN_DATE,M2.ST,M1.AVG_Q 
FROM MAX_DATA M1,MIN_DATA M2
WHERE M1.PROD = M2.PROD;

/*----------Query 2----------*/

WITH S_DATA AS (
	SELECT S.cust, S.prod,S.state, MAX(S.QUANT) MAX_Q ,MIN(S.QUANT) MIN_Q 
	FROM SALES S 
	GROUP BY S.CUST, S.PROD , S.STATE),
MIN_DATE_DATA AS (
	SELECT S6.CUST,S6.PROD, S7.STATE, S6.MIN_Q, S7.DATE 
	FROM S_DATA S6 ,SALES S7
	WHERE S6.CUST = S7.CUST
	AND S6.PROD = S7.PROD
	AND S6.STATE = S7.STATE
	AND S6.MIN_Q = S7.QUANT
	AND S7.YEAR > 2000),
NY_DATA AS(	
	SELECT S1.CUST, S1.PROD , S1.STATE , S1.MAX_Q NY_QUANT , S3.DATE NY_DATE 
	FROM S_DATA S1 ,SALES S3
	WHERE S1.CUST = S3.CUST 
	AND S1.PROD = S3.PROD 
	AND S1.MAX_Q = S3.QUANT
	AND S1.STATE = S3.STATE
	AND S1.STATE = 'NY'),
NJ_DATA AS(	
	SELECT SD.CUST, SD.PROD , SD.STATE , SD.MIN_Q NJ_QUANT,S8.DATE NJ_DATE
 	FROM S_DATA SD,MIN_DATE_DATA S8
 	WHERE SD.STATE = S8.STATE
 	AND SD.CUST = S8.CUST
 	AND SD.PROD = S8.PROD
 	AND SD.MIN_Q = S8.MIN_Q
 	AND SD.STATE = 'NJ'),
CT_DATA AS(	
	SELECT SD1.CUST, SD1.PROD , SD1.STATE , SD1.MIN_Q CT_QUANT ,S9.DATE CT_DATE
 	FROM S_DATA SD1 ,MIN_DATE_DATA S9
	WHERE SD1.STATE = S9.STATE
 	AND SD1.CUST = S9.CUST
 	AND SD1.PROD = S9.PROD
 	AND SD1.MIN_Q = S9.MIN_Q
 	AND SD1.STATE = 'CT'),
NJ_CT_DATA AS (	
	SELECT NJ.CUST, NJ.PROD , NJ.STATE, (NJ.NJ_QUANT + CT.CT_QUANT) NC_QUANT,NJ_QUANT, CT_QUANT ,NJ_DATE ,CT_DATE
 	FROM NJ_DATA NJ , CT_DATA CT 
	WHERE NJ.CUST = CT.CUST
	AND NJ.PROD = CT.PROD)
SELECT NY.CUST CUSTOMER, NY.PROD PRODUCT, NY.NY_QUANT NY_MAX ,NY.NY_DATE DATE,NC.NJ_QUANT NJ_MIN ,NJ_DATE DATE, NC.CT_QUANT CT_MIN ,CT_DATE DATE 
FROM NJ_CT_DATA NC, NY_DATA NY
WHERE NY.CUST = NC.CUST
AND NY.PROD = NC.PROD
AND NY.NY_QUANT > NC.NC_QUANT;

/*----------Query 3----------*/

WITH M_DATA AS (
	SELECT MONTH,STATE, SUM(QUANT) SUM_Q 
	FROM SALES S
	GROUP BY S.MONTH,STATE
	ORDER BY MONTH),
M_DATA2 AS (
	SELECT MONTH , MAX(SUM_Q) MAX_Q ,MIN(SUM_Q) MIN_Q  
	FROM M_DATA M
	GROUP BY M.MONTH)
			
SELECT M.MONTH, M.STATE MOST_POPULAR_ST ,M2.MAX_Q MOST_POP_TOTAL_Q,M4.STATE LEAST_POPULAR_ST,  M2.MIN_Q LEAST_POP_TOTAL_Q 
FROM M_DATA2 M2 ,M_DATA M ,M_DATA M4
WHERE M2.MONTH = M.MONTH
AND M.SUM_Q = M2.MAX_Q
AND M2.MONTH = M4.MONTH
AND M4.SUM_Q = M2.MIN_Q
AND M.MONTH = M4.MONTH;

/*----------Query 4----------*/

WITH S_DATA AS (
	SELECT S.CUST,PROD , MAX(S.QUANT) MAX_Q, MIN(S.QUANT) MIN_Q,SUM(S.QUANT) S_QUANT 
	FROM SALES S
	GROUP BY S.CUST,PROD 
	ORDER BY CUST,S_QUANT),
MAX_MIN_DATA AS (
	SELECT S.CUST ,MAX(S_QUANT) M_S_QUANT ,MIN(S_QUANT) MIN_S_QUANT 
	FROM S_DATA S 
	GROUP BY S.CUST),
MAX_DATA AS (
	SELECT S.CUST, S.PROD MOST_FAV_PROD, M_S_QUANT 
	FROM S_DATA S, MAX_MIN_DATA M 
	WHERE S.CUST = M.CUST
	AND M.M_S_QUANT = S.S_QUANT),
MIN_DATA AS (
	SELECT S.CUST, S.PROD LEAST_FAV_PROD, MIN_S_QUANT 
	FROM S_DATA S, MAX_MIN_DATA M 
	WHERE S.CUST = M.CUST
	AND M.MIN_S_QUANT = S.S_QUANT),
ST_DATA AS (
	SELECT S.CUST,STATE , COUNT(S.QUANT) S_QUANT 
	FROM SALES S
	GROUP BY S.CUST,STATE ),
MAX_MIN_ST_DATA AS (
	SELECT ST.CUST ,MAX(S_QUANT) M_ST_QUANT ,MIN(S_QUANT) MIN_ST_QUANT 
	FROM ST_DATA ST 
	GROUP BY ST.CUST),
MAX_ST_DATA AS (
	SELECT S.CUST, S.STATE MOST_FAV_ST, M_ST_QUANT 
	FROM ST_DATA S, MAX_MIN_ST_DATA M1 
	WHERE S.CUST = M1.CUST
	AND M1.M_ST_QUANT = S.S_QUANT),
MIN_ST_DATA AS (
	SELECT S.CUST, S.STATE LEAST_FAV_ST, MIN_ST_QUANT 
	FROM ST_DATA S, MAX_MIN_ST_DATA M 
	WHERE S.CUST = M.CUST
	AND M.MIN_ST_QUANT = S.S_QUANT)
SELECT MX.CUST CUSTOMER, MX.MOST_FAV_PROD , MN.LEAST_FAV_PROD , M2.MOST_FAV_ST,LEAST_FAV_ST 
FROM MIN_DATA MN,MAX_DATA MX,MAX_ST_DATA M2,MIN_ST_DATA M3
WHERE MX.CUST = MN.CUST
AND MN.CUST = M2.CUST
AND M2.CUST = M3.CUST;

/*----------Query 5----------*/

WITH SQ1_DATA AS (
	SELECT  S.CUST ,S.PROD ,S.MONTH, SUM(S.QUANT) TOTAL_Q1 
	FROM SALES S 
	GROUP BY S.CUST , S.PROD,S.MONTH 
	HAVING MONTH IN (1,2,3)),
SQ2_DATA AS (
	SELECT  S.CUST ,S.PROD ,S.MONTH, SUM(S.QUANT) TOTAL_Q2 
	FROM SALES S 
	GROUP BY S.CUST , S.PROD,S.MONTH 
	HAVING MONTH IN (4,5,6)),
SQ3_DATA AS (
	SELECT  S.CUST ,S.PROD ,S.MONTH, SUM(S.QUANT) TOTAL_Q3 
	FROM SALES S 
	GROUP BY S.CUST , S.PROD,S.MONTH 
	HAVING MONTH IN (7,8,9)),
SQ4_DATA AS (
	SELECT  S.CUST ,S.PROD ,S.MONTH, SUM(S.QUANT) TOTAL_Q4 
	FROM SALES S 
	GROUP BY S.CUST , S.PROD,S.MONTH 
	HAVING MONTH IN (10,11,12)),
Q1 AS (
	SELECT CUST,PROD,SUM(TOTAL_Q1) Q1_QUANT 
	FROM SQ1_DATA SQ1
	GROUP BY CUST,PROD),
Q2 AS (
	SELECT CUST,PROD,SUM(TOTAL_Q2) Q2_QUANT 
	FROM SQ2_DATA SQ2
	GROUP BY CUST,PROD),
Q3 AS (
	SELECT CUST,PROD,SUM(TOTAL_Q3) Q3_QUANT 
	FROM SQ3_DATA SQ3
	GROUP BY CUST,PROD),
Q4 AS (
	SELECT CUST,PROD,SUM(TOTAL_Q4) Q4_QUANT 
	FROM SQ4_DATA SQ4
	GROUP BY CUST,PROD),
S_DATA AS (
	SELECT S.CUST, S.PROD,SUM(S.QUANT) TOTAL, AVG(S.QUANT) AVERAGE,COUNT(S.QUANT)  
	FROM SALES S 
	GROUP BY S.CUST , S.PROD)
SELECT Q1.CUST CUSTOMER, Q1.PROD PRODUCT,Q1_QUANT Q1_TOT,Q2_QUANT Q2_TOT,Q3_QUANT Q3_TOT,Q4_QUANT Q4_TOT,AVERAGE,TOTAL,SD.COUNT 
FROM Q1,Q2,Q3,Q4,S_DATA SD
WHERE Q1.CUST = Q2.CUST
AND Q1.PROD = Q2.PROD
AND Q2.CUST = Q3.CUST
AND Q2.PROD = Q3.PROD
AND Q3.CUST = Q4.CUST
AND Q3.PROD = Q4.PROD
AND Q4.CUST = SD.CUST
AND Q4.PROD = SD.PROD;